---
title: "API Reference: @apollo/gateway"
sidebar_title: "@apollo/gateway"
description: Apollo Gateway API reference
api_reference: true
---

This API reference documents the exports from the `@apollo/gateway` package.

## `class ApolloGateway`

The core class of Apollo Server's federated gateway implementation. For an
example of using `ApolloGateway`, see [The gateway](/gateway/).

### Methods

#### `constructor`

Returns an initialized `ApolloGateway` instance, which you can then pass as the `gateway` configuration option to the `ApolloServer` constructor, like so:

```javascript{2-6}
const server = new ApolloServer({
  gateway: new ApolloGateway({
    serviceList: [
      // ...
    ]
  }),
});
```

Takes an `options` object as a parameter. Supported fields of this object are described below.

##### Examples

###### Providing a `serviceList` and headers to authorize introspection

```js
const gateway = new ApolloGateway({
  serviceList: [
    { name: 'products', url: 'https://products-service.dev/graphql' },
    { name: 'reviews', url: 'https://reviews-service.dev/graphql' }
  ],
  introspectionHeaders: {
    Authorization: 'Bearer abc123'
  }
});
```

###### Configuring the fetcher

```js
const gateway = new ApolloGateway({
  fetcher: require('make-fetch-happen').defaults({
    onRetry() {
      console.log('we will retry!')
    },
  }),
});
```

##### Options

<table class="field-table">
  <thead>
    <tr>
      <th>Name /<br/>Type</th>
      <th>Description</th>
    </tr>
  </thead>

<tbody>
<tr class="required">
<td>

###### `serviceList`

`Array<ServiceDefinition>`
</td>
<td>

An array of objects that each specify the `name` and `url` of one implementing service in your federated graph.

You can specify any string value for the `name` field, which is used for identifying the service in log output and error messages, and for reporting metrics to Apollo Studio.

**If you are using managed federation,** do not provide this field.

**If you _aren't_ using managed federation,** this field is required.


</td>
</tr>


<tr>
<td>

###### `apq`

`Boolean`
</td>
<td>

If `true`, the gateway attempts to use [automated persisted queries (APQ)](https://www.apollographql.com/docs/apollo-server/performance/apq/) when sending queries to implementing services. APQ can dramatically reduce the size of most requests sent over the network, especially for more complex queries.

Your implementing services must also enable support for APQ for the gateway to use this feature (Apollo Server enables APQ by default).
</td>
</tr>


<tr>
<td>

###### `introspectionHeaders`

`Object`
</td>
<td>

An object containing the names and values of HTTP headers that the gateway includes _only_ when making introspection requests to your implementing services.

**If you are using managed federation,** do not provide this field.

**If you define a `buildService` function,** specify these headers in that function instead of providing this option. This ensures that your `buildService` function doesn't inadvertently overwrite the values of any headers you provide here.
</td>
</tr>


<tr>
<td>

###### `debug`

`Boolean`
</td>
<td>

If `true`, enables development mode helpers and logs messages of all severity levels (`debug` through `error`). If `false`, only `warn`- and `error`-level messages are logged.

The default value is `false`.
</td>
</tr>


<tr>
<td>

###### `logger`

[`Logger`](https://github.com/apollographql/apollo-server/blob/main/packages/apollo-server-types/src/index.ts#L166-L172)
</td>
<td>

An object to use for logging in place of `console`. If provided, this object must implement all methods of [the `Logger` interface](https://github.com/apollographql/apollo-server/blob/main/packages/apollo-server-types/src/index.ts#L166-L172).

If you provide this value, the gateway automatically logs all messages of _all_ severity levels (`debug` through `error`), regardless of whether the `debug` option is set to `true`. It is the responsibility of the logger to determine how to handle logged messages of each level.

This logger is automatically added to the `GraphQLRequestContext` object that's passed to all Apollo Server [plugin functions](../integrations/plugins/).
</td>
</tr>


<tr>
<td>

###### `fetcher`

`typeof fetch`
</td>
<td>

Specifies which [Fetch API](https://fetch.spec.whatwg.org/#fetch-api) implementation to use when communicating with implementing services.

By default, the gateway uses the default configuration of [`make-fetch-happen`](https://npm.im/make-fetch-happen). You can specify another valid implementation (such as [`node-fetch`](https://npm.im/node-fetch)) by setting this field's value to `require('node-fetch')`.

As shown in the example above, you can also provide [`make-fetch-happen`](https://www.npmjs.com/package/make-fetch-happen#extra-options) to this option if you want to override the library's default configuration.
</td>
</tr>


<tr>
<td>

###### `serviceHealthCheck`

`Boolean`
</td>
<td>

If `true`, the gateway sends a small query (`{ __typename }`) to all implementing services on gateway startup. It also does the same on each live schema update if you're using managed federation.

**On startup,** the gateway throws an error if any of these requests fail.

**On schema update,** the gateway does not roll over to the new schema or service configuration if any of these requests fail. The gateway retries the requests at each polling interval until they succeed.

The default value is `false`.
</td>
</tr>


</tbody>
</table>

  * `buildService`: `(service: ServiceDefinition) => GraphQLDataSource`

    Define this function to customize your gateway's data transport to some or
    all of your data graph's implementing services. This customization can
    include using a protocol besides the default of HTTP.

    If you provide this function, `ApolloGateway` calls it for every
    implementing service in your data graph. The function must return an object
    that implements the [`GraphQLDataSource` interface](https://github.com/apollographql/apollo-server/blob/570f548b88/packages/apollo-gateway/src/datasources/types.ts), such as an instance of [RemoteGraphQLDataSource](#remotegraphqldatasource) or a subclass of it.

    The example below demonstrates adding an `x-user-id`
    HTTP header to every request the gateway sends to an implementing service:

    ```js{1-5,9-11}
    class AuthenticatedDataSource extends RemoteGraphQLDataSource {
      willSendRequest({ request, context }) {
        request.http.headers.set('x-user-id', context.userId);
      }
    }

    const gateway = new ApolloGateway({
      ...
      buildService({ name, url }) {
        return new AuthenticatedDataSource({ url });
      },
    });
    ```

##### Experimental options

**These options are experimental.**  They might be removed or change at any time, even within a patch release.

<table class="field-table">
  <thead>
    <tr>
      <th>Name /<br/>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
<tr>
<td>

###### `experimental_approximateQueryPlanStoreMiB`

`number`
</td>
<td>

Sets the approximate size (in MiB) of the gateway's query plan store. This cache is used to save query plans for reuse on subsequent queries that resolve to a previously observed `queryHash` (the SHA-256 of the incoming operation).

The default value is `30`, which is usually sufficient unless the server processes a large number of unique operations.
</td>
</tr>
</tbody>
</table>

#### `serviceHealthCheck`

When called, the gateway sends a small query (`{ __typename }`) to each implementing service to verify that they're all responsive. This function `throw`s on failure and returns a `Promise` to be `await`ed.

##### Parameters

<table class="field-table">
  <thead>
    <tr>
      <th>Name /<br/>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
<tr>
<td>

###### `serviceMap`

`Object` (`DataSourceMap`)
</td>
<td>

If provided, the gateway sends health check requests to only the data sources included in the map.

By default, the gateway uses `this.serviceMap` (i.e., it sends health check requests to all known implementing services).
</td>
</tr>
</tbody>
</table>


## `class RemoteGraphQLDataSource`

A `RemoteGraphQLDataSource` object represents a connection between your
federated gateway and _one_ of your implementing services.

You can customize this connection by defining a subclass of this class and
overriding its `willSendRequest` and/or `didReceiveResponse` methods:

* The `willSendRequest` method lets you modify your gateway's requests to the implementing service before they're sent.
* The `didReceiveResponse` method lets you modify the implementing service's responses before the gateway passes them along to the requesting client.

These methods are described in detail below.

### Methods

#### `constructor(options)`: `RemoteGraphQLDataSource`

##### Parameters

* `options`: `Object`

  An object that contains configuration options for the data source.

  Supported options include:

  * `url`: `string` _(required)_

    The implementing service's URL for sending fetch requests via HTTP.

  #### `willSendRequest`: `(requestContext: {request: GraphQLRequest, context: Record<string, any>}) => Promise<void>`

    Override this method to customize the structure of each fetch that's sent
    to the implementing service. The method accepts an object that contains
    both the original incoming `request` and the current `context`.

    The example below demonstrates using the `willSendRequest` method to
    add an `x-user-id` HTTP header to every request the gateway sends to an implementing service:

    ```js{2-4}
    class AuthenticatedDataSource extends RemoteGraphQLDataSource({
      willSendRequest({ request, context }) {
        request.http.headers.set('x-user-id', context.userId);
      }
    });
    ```

  #### `didReceiveResponse`: `(requestContext: {request: GraphQLRequest, response: GraphQLResponse, context: Record<string, any>}) => Promise<GraphQLResponse>`

    Override this method to customize the gateway's behavior after completing
    a fetch to the implementing service. The method receives an object (a
    [`GraphQLRequestContext`](https://github.com/apollographql/apollo-server/blob/2562d096/packages/apollo-server-types/src/index.ts#L61-L92))
    containing the `request` (a `GraphQLRequest`), the implementing service's
    `response` (a `GraphQLResponse`), and the current `context` as parameters.
    This allows modification of the context and the final result of the fetch.

    The `http` property on the `request` and `response` objects will contain
    additional HTTP-specific properties, like `headers`.

    Any implementation of this method must return an object that matches the
    structure of a [`GraphQLResponse`](https://github.com/apollographql/apollo-server/blob/2562d096/packages/apollo-server-types/src/index.ts#L43-L48)
    (i.e., it should include `http`, `data`, `errors`, and/or `extensions`
    fields).  If no modifications are necessary, simply return the original
    `response`.

    ```javascript
    class CookieDataSource extends RemoteGraphQLDataSource {
      didReceiveResponse({ response, request, context }) {
        const cookie = request.http.headers.get('Cookie');
        if (cookie) {
          context.responseCookies.push(cookie);
        }

        // Return the response back, even when unchanged.
        return response;
      }
    }
    ```
